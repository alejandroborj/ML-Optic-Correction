option, -echo;
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/beta_beat.macros.madx";
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/lhc.macros.madx";
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/lhc_runII.macros.madx";
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/beta_beat.macros.madx";
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/lhc.macros.madx";
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/lhc_runII.macros.madx";
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/lhc_runII_ats.macros.madx";
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/lhc_runIII_2022.macros.madx";
call, file = "/afs/cern.ch/eng/sl/lintrack/Beta-Beat.src/madx/lib/segments.macros.madx";
option, echo;

!@require lhc_runIII_2022
!@require segments

option, -echo;

call, file = "/afs/cern.ch/eng/acc-models/lhc/2022/lhc.seq";

exec, define_nominal_beams();
call, file = "/user/slops/data/LHC_DATA/OP_DATA/Betabeat/2022-04-27/LHCB1/Results/b1_30cm_beforeKmod/sbs_auto/modifiers.madx";
exec, set_default_crossing_scheme();

! Cycle the sequence in the start point to
! avoid negative length sequence.
seqedit, sequence=LHCB1;
flatten;
cycle, start=BPMR.7L1.B1;
endedit;

use, period = LHCB1;

option, echo;

twiss;

exec, save_initial_and_final_values(
    LHCB1,
    BPMR.7L1.B1,
    BPMSX.7R1.B1,
    "/user/slops/data/LHC_DATA/OP_DATA/Betabeat/2022-04-27/LHCB1/Results/b1_30cm_beforeKmod/sbs_auto//measurementbampaphase_IP1.madx",
    biniLHCB1,
    bendLHCB1
);

exec, extract_segment_sequence(
    LHCB1,
    front_LHCB1, back_LHCB1,
    BPMR.7L1.B1, BPMSX.7R1.B1
);
exec, beam_LHCB1(front_LHCB1);
exec, beam_LHCB1(back_LHCB1);


exec, twiss_segment(front_LHCB1, "/user/slops/data/LHC_DATA/OP_DATA/Betabeat/2022-04-27/LHCB1/Results/b1_30cm_beforeKmod/sbs_auto//twissbampaphase_IP1.dat", biniLHCB1);
exec, twiss_segment(back_LHCB1, "/user/slops/data/LHC_DATA/OP_DATA/Betabeat/2022-04-27/LHCB1/Results/b1_30cm_beforeKmod/sbs_auto//twissbampaphase_IP1_back.dat", bendLHCB1);

call, file="/user/slops/data/LHC_DATA/OP_DATA/Betabeat/2022-04-27/LHCB1/Results/b1_30cm_beforeKmod/sbs_auto//corrections_IP1.madx";

exec, twiss_segment(front_LHCB1, "/user/slops/data/LHC_DATA/OP_DATA/Betabeat/2022-04-27/LHCB1/Results/b1_30cm_beforeKmod/sbs_auto//twissbampaphase_IP1_cor.dat", biniLHCB1);
exec, twiss_segment(back_LHCB1, "/user/slops/data/LHC_DATA/OP_DATA/Betabeat/2022-04-27/LHCB1/Results/b1_30cm_beforeKmod/sbs_auto//twissbampaphase_IP1_cor_back.dat", bendLHCB1);
